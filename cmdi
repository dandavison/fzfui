#!/usr/bin/env bash
set -euo pipefail

# cmdi - command-mode fzf wrapper
# Provides two modes: query mode (filter output) and command mode (edit command)

usage() {
    cat <<EOF
Usage: cmdi <command> [--config <file>] [-- extra fzf args...]

Arguments:
  <command>     The command to run (quoted if contains spaces)
  --config      Path to config file with fzf options (ripgrep-style)
  --            Everything after is passed directly to fzf

Modes:
  Query mode (default): Filter output with fzf, command shown in footer
  Command mode (ctrl-\\): Edit command live, query shown in footer

Example:
  cmdi "ps aux" --config ~/.config/cmdi/ps.conf
  cmdi "snitch ls -t" -- --header-lines 4
EOF
    exit 1
}

[[ $# -lt 1 ]] && usage

# Resolve symlinks to find actual script directory (where helpers live)
SCRIPT="$0"
[[ -L "$SCRIPT" ]] && SCRIPT="$(readlink "$SCRIPT")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT")" && pwd)"
export SCRIPT_DIR
export PATH="$SCRIPT_DIR:$PATH"

# Parse arguments
CMD="$1"
shift

CONFIG_FILE=""
EXTRA_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --config)
            CONFIG_FILE="$2"
            shift 2
            ;;
        --)
            shift
            EXTRA_ARGS=("$@")
            break
            ;;
        *)
            EXTRA_ARGS+=("$1")
            shift
            ;;
    esac
done

# Read config file (ripgrep-style: one option per line)
CONFIG_ARGS=()
if [[ -n "$CONFIG_FILE" && -f "$CONFIG_FILE" ]]; then
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines and comments
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        CONFIG_ARGS+=("$line")
    done < "$CONFIG_FILE"
fi

# State management
STATE_FILE="/tmp/cmdi-$$.state"
export STATE_FILE
trap 'rm -f "$STATE_FILE"' EXIT

# State format: mode|query|command
echo "query||$CMD" > "$STATE_FILE"

# Run fzf with mode-switching machinery + config + extra args
eval "$CMD" 2>/dev/null | fzf \
    --ansi \
    --border none \
    --no-separator \
    --footer "$CMD" \
    --prompt '/ ' \
    --with-shell 'bash -c' \
    --bind 'ctrl-\:transform:cmdi-toggle' \
    --bind 'change:transform:cmdi-on-change' \
    "${CONFIG_ARGS[@]}" \
    "${EXTRA_ARGS[@]}"

