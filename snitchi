#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks to find actual script directory (where helpers live)
SCRIPT="$0"
[[ -L "$SCRIPT" ]] && SCRIPT="$(readlink "$SCRIPT")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT")" && pwd)"
export SCRIPT_DIR
export PATH="$SCRIPT_DIR:$PATH"

STATE_FILE="/tmp/snitchi-$$.state"
export STATE_FILE
trap 'rm -f "$STATE_FILE"' EXIT

# Build initial command
CMD="snitch ls${*:+ $*}"

# State format: mode|query|command
echo "query||$CMD" > "$STATE_FILE"

eval "$CMD" 2>/dev/null | sed 's/^  //' | fzf \
    --ansi \
    --header-lines 4 \
    --border none \
    --no-separator \
    --delimiter 'â”‚' \
    --footer "$CMD" \
    --prompt '/ ' \
    --with-shell 'bash -c' \
    --bind 'ctrl-k:execute-silent(kill -9 $(echo {2} | xargs))' \
    --bind 'ctrl-\:transform:snitchi-toggle' \
    --bind 'change:transform:snitchi-on-change' \
    --bind 'ctrl-h:execute(tmux display-popup -E -w 70 -h 25 -T " snitchi help " "$SCRIPT_DIR/snitchi-help | less -R")'
