#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.10"
# dependencies = ["fzfui"]
# [tool.uv.sources]
# fzfui = { path = "/Users/dan/src/fzfui", editable = true }
# ///

from __future__ import annotations

import os
import subprocess
from textwrap import dedent

import fzfui

app = fzfui.App(__file__)


@app.main(
    command="ps -U $USER -o pid,%cpu,%mem,stat,time,command | cut -c1-200",
    header_lines=1,
    with_nth="2..",
)
def psi():
    pass


@app.action("enter", field=1)
def detail(pid: str):
    pid = pid.strip()
    if not pid.isdigit():
        return

    result = subprocess.run(
        ["ps", "-p", pid, "-o", "pid=,user=,%cpu=,%mem=,stat=,start=,time=,command="],
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        print(f"Process {pid} not found")
        input("Press any key...")
        return

    parts = result.stdout.strip().split(None, 7)
    info = dict(zip(
        ["pid", "user", "cpu", "mem", "stat", "start", "time", "cmd"],
        parts + [""] * (8 - len(parts)),
    ))
    info["cmd"] = info["cmd"][:70]

    lsof_result = subprocess.run(["lsof", "-p", pid], capture_output=True, text=True)
    if lsof_result.returncode == 0:
        lines = lsof_result.stdout.strip().split("\n")[1:21]
        files = "\n".join(
            f"    {p[4]:10} {p[8]}"
            for line in lines
            if len(p := line.split()) >= 9
        ) or "    (none)"
    else:
        files = "    (permission denied)"

    os.system("clear")
    print(dedent(f"""
        ═══════════════════════════════════════════════════════════════════
          PROCESS DETAILS (PID: {pid})
        ═══════════════════════════════════════════════════════════════════

          PID      {info['pid']}
          User     {info['user']}
          CPU      {info['cpu']}
          Memory   {info['mem']}
          State    {info['stat']}
          Started  {info['start']}
          Time     {info['time']}

          Command:
            {info['cmd']}

        ───────────────────────────────────────────────────────────────────
          Open files/ports (first 20):
        {files}

        ═══════════════════════════════════════════════════════════════════
    """))
    input("Press any key...")


@app.action("ctrl-k", reload=True, silent=True, field=1)
def kill_proc(pid: str):
    pid = pid.strip()
    if pid.isdigit():
        try:
            os.kill(int(pid), 9)
        except ProcessLookupError:
            pass


@app.action("ctrl-r", reload=True, silent=True)
def reload(_: str):
    pass


@app.preview
def help_panel(_: str) -> str:
    return dedent("""\
        ╭──────────────────────────────────────────────────────────────╮
        │                        Keybindings                           │
        ╰──────────────────────────────────────────────────────────────╯

          enter       Show process details
          ctrl-k      Kill process (SIGKILL)
          ctrl-r      Reload process list
          ctrl-h      Toggle this help
          ctrl-\\      Toggle query/command mode
          esc         Exit

        ╭──────────────────────────────────────────────────────────────╮
        │                         Columns                              │
        ╰──────────────────────────────────────────────────────────────╯

          %CPU    CPU usage percentage
          %MEM    Memory usage percentage
          STAT    Process state (S=sleeping, R=running, etc.)
          TIME    Cumulative CPU time
          COMMAND Process command (truncated)

          PID is hidden but used for kill/details.
        """)


if __name__ == "__main__":
    app()

