#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.10"
# dependencies = ["fzfui"]
# ///

from __future__ import annotations

import os
import subprocess
from textwrap import dedent

import fzfui

app = fzfui.App(__file__)


PS_CMD = "ps -U $USER -o pid,%cpu,%mem,stat,time,command | cut -c1-200"
# Filter to processes with listening ports (macOS lsof), showing ports as a column
LISTENING_CMD = r"""
(printf "%-7s %-18s %5s %5s %-4s %-11s %s\n" "PID" "PORTS" "%CPU" "%MEM" "STAT" "TIME" "COMMAND"
lsof -iTCP -sTCP:LISTEN -P -n 2>/dev/null | awk '
NR>1 {
    pid=$2; port=$9
    sub(/.*:/, "", port); sub(/\(LISTEN\)/, "", port)
    if (pid in ports) ports[pid]=ports[pid]","port
    else ports[pid]=port
}
END { for (pid in ports) print pid, ports[pid] }
' | while read pid ports; do
    ps -p "$pid" -o %cpu=,%mem=,stat=,time=,command= 2>/dev/null | head -1 | \
    awk -v pid="$pid" -v ports="$ports" '{
        printf "%-7s %-18s %5s %5s %-4s %-11s ", pid, ports, $1, $2, $3, $4
        for(i=5;i<=NF;i++) printf "%s ", $i; print ""
    }'
done) | cut -c1-200
"""


@app.main(
    command=PS_CMD,
    header_lines=1,
    with_nth="2..",
    bindings={
        "ctrl-l": f"reload({LISTENING_CMD})+change-footer(listening processes)",
        "ctrl-a": f"reload({PS_CMD})+change-footer({PS_CMD})",
    },
)
def psi():
    pass


@app.action("enter", field=1)
def detail(pid: str):
    pid = pid.strip()
    if not pid.isdigit():
        return

    result = subprocess.run(
        ["ps", "-p", pid, "-o", "pid=,user=,%cpu=,%mem=,stat=,start=,time=,command="],
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        print(f"Process {pid} not found")
        input("Press any key...")
        return

    parts = result.stdout.strip().split(None, 7)
    info = dict(
        zip(
            ["pid", "user", "cpu", "mem", "stat", "start", "time", "cmd"],
            parts + [""] * (8 - len(parts)),
        )
    )
    info["cmd"] = info["cmd"][:70]

    lsof_result = subprocess.run(["lsof", "-p", pid], capture_output=True, text=True)
    if lsof_result.returncode == 0:
        lines = lsof_result.stdout.strip().split("\n")[1:21]
        files = (
            "\n".join(
                f"        {p[4]:10} {p[8]}"
                for line in lines
                if len(p := line.split()) >= 9
            )
            or "        (none)"
        )
    else:
        files = "        (permission denied)"

    os.system("clear")
    print(
        dedent(f"""
        ═══════════════════════════════════════════════════════════════════
          PROCESS DETAILS (PID: {pid})
        ═══════════════════════════════════════════════════════════════════

          PID      {info["pid"]}
          User     {info["user"]}
          CPU      {info["cpu"]}
          Memory   {info["mem"]}
          State    {info["stat"]}
          Started  {info["start"]}
          Time     {info["time"]}

          Command:
            {info["cmd"]}

        ───────────────────────────────────────────────────────────────────
          Open files/ports (first 20):
        {files}

        ═══════════════════════════════════════════════════════════════════
    """)
    )
    input("Press any key...")


@app.action("ctrl-k", reload=True, silent=True, field=1)
def kill_proc(pid: str):
    pid = pid.strip()
    if pid.isdigit():
        try:
            os.kill(int(pid), 9)
        except ProcessLookupError:
            pass


@app.action("ctrl-r", reload=True, silent=True)
def reload(_: str):
    pass


def get_listening_ports(pid: str) -> str:
    """Get listening ports for a given PID."""
    result = subprocess.run(
        ["lsof", "-iTCP", "-sTCP:LISTEN", "-P", "-n", "-p", pid],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0 or not result.stdout.strip():
        return ""

    ports = []
    for line in result.stdout.strip().split("\n")[1:]:  # Skip header
        parts = line.split()
        if len(parts) >= 9:
            # NAME field contains address:port
            addr = parts[8]
            if ":" in addr:
                port = addr.rsplit(":", 1)[1]
                if port not in ports:
                    ports.append(port)
    return ", ".join(ports) if ports else ""


@app.preview
def help_panel(selection: str) -> str:
    # Extract PID from selection (first field)
    pid = selection.split()[0] if selection else ""
    ports_info = ""

    if pid and pid.isdigit():
        ports = get_listening_ports(pid)
        if ports:
            ports_info = f"""
        ╭──────────────────────────────────────────────────────────────╮
        │                    Listening Ports                           │
        ╰──────────────────────────────────────────────────────────────╯

          PID {pid} is listening on: {ports}

"""

    return ports_info + dedent("""\
        ╭──────────────────────────────────────────────────────────────╮
        │                        Keybindings                           │
        ╰──────────────────────────────────────────────────────────────╯

          enter       Show process details
          ctrl-k      Kill process (SIGKILL)
          ctrl-l      Filter to listening processes
          ctrl-a      Show all processes
          ctrl-r      Reload process list
          ctrl-h      Toggle this help
          ctrl-\\      Toggle query/command mode
          esc         Exit

        ╭──────────────────────────────────────────────────────────────╮
        │                         Columns                              │
        ╰──────────────────────────────────────────────────────────────╯

          %CPU    CPU usage percentage
          %MEM    Memory usage percentage
          STAT    Process state (S=sleeping, R=running, etc.)
          TIME    Cumulative CPU time
          COMMAND Process command (truncated)

          PID is hidden but used for kill/details.
        """)


if __name__ == "__main__":
    app()
